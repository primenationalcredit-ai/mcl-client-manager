<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MCL Client Manager</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --navy:#003f87; --navy-dark:#002d63; --navy-light:#e8f0fa;
  --gold:#c9952b; --gold-light:#fef9ef;
  --red:#dc2626; --red-light:#fef2f2;
  --green:#16a34a; --green-light:#f0fdf4;
  --g50:#f9fafb; --g100:#f3f4f6; --g200:#e5e7eb; --g300:#d1d5db;
  --g400:#9ca3af; --g500:#6b7280; --g600:#4b5563; --g700:#374151;
  --g800:#1f2937; --g900:#111827;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',-apple-system,sans-serif;background:var(--g50);color:var(--g800);min-height:100vh;}
button{font-family:inherit;cursor:pointer;}
input,select,textarea{font-family:inherit;}

/* NAV */
.topnav{background:var(--navy-dark);padding:0 24px;height:52px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;}
.topnav-brand{color:#fff;font-weight:700;font-size:15px;display:flex;align-items:center;gap:8px;}
.topnav-right{display:flex;align-items:center;gap:12px;}
.badge-alert{background:var(--red);color:#fff;font-size:11px;font-weight:700;padding:2px 8px;border-radius:20px;}

/* LAYOUT */
.app{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 52px);}

/* SIDEBAR */
.sidebar{background:#fff;border-right:1px solid var(--g200);overflow-y:auto;}
.sb-section{padding:14px;border-bottom:1px solid var(--g100);}
.sb-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--g400);margin-bottom:8px;}
.stage-btn{width:100%;display:flex;align-items:center;justify-content:space-between;padding:9px 10px;border:none;background:transparent;border-radius:8px;margin-bottom:3px;transition:all .12s;}
.stage-btn:hover{background:var(--g50);}
.stage-btn.active{background:var(--navy-light);}
.sb-left{display:flex;align-items:center;gap:8px;}
.sb-icon{font-size:16px;}
.sb-label{font-size:13px;font-weight:600;color:var(--g800);}
.sb-right{display:flex;align-items:center;gap:5px;}
.sb-count{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;color:var(--g500);background:var(--g100);padding:1px 7px;border-radius:10px;}
.sb-overdue{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;color:#fff;background:var(--red);padding:1px 5px;border-radius:10px;min-width:16px;text-align:center;}

/* CLIENT LIST */
.search-box{width:100%;padding:7px 10px;border:1px solid var(--g200);border-radius:8px;font-size:12px;outline:none;margin-bottom:8px;}
.search-box:focus{border-color:var(--navy);}
.client-list{list-style:none;}
.client-item{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all .1s;}
.client-item:hover{background:var(--g50);}
.client-item.active{background:var(--navy-light);border-color:var(--navy);}
.ci-left{display:flex;flex-direction:column;min-width:0;}
.ci-name{font-size:13px;font-weight:600;color:var(--g800);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ci-sub{font-size:11px;color:var(--g400);margin-top:1px;}
.dot{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
.dot.overdue{background:var(--red);}
.dot.due_today{background:var(--gold);}
.dot.on_track{background:var(--green);}
.dot.responded{background:var(--navy);}
.dot.needs_intro{background:var(--g300);}
.dot.resolved{background:var(--g300);}

/* ADD CLIENT BTN */
.add-btn{width:100%;padding:8px;border:2px dashed var(--g200);border-radius:8px;background:transparent;color:var(--g400);font-size:13px;font-weight:600;margin-top:8px;transition:all .12s;}
.add-btn:hover{border-color:var(--navy);color:var(--navy);}

/* MAIN */
.main{overflow-y:auto;padding:24px 28px;}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 14px;border-radius:8px;border:none;font-size:13px;font-weight:600;transition:all .12s;white-space:nowrap;}
.btn-navy{background:var(--navy);color:#fff;}.btn-navy:hover{background:var(--navy-dark);}
.btn-green{background:var(--green);color:#fff;}.btn-green:hover{background:#15803d;}
.btn-red{background:transparent;color:var(--g400);border:1px solid var(--g200);}.btn-red:hover{border-color:var(--red);color:var(--red);}
.btn-outline{background:transparent;color:var(--g600);border:1px solid var(--g200);}.btn-outline:hover{border-color:var(--navy);color:var(--navy);}
.btn-sm{padding:5px 10px;font-size:12px;}
.btn-gold{background:var(--gold);color:#fff;}.btn-gold:hover{background:#b8862a;}

/* PROFILE HEADER */
.prof-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;}
.prof-name{font-size:22px;font-weight:700;color:var(--g900);}
.prof-meta{display:flex;gap:14px;flex-wrap:wrap;margin-top:4px;}
.prof-meta span{font-size:13px;color:var(--g500);display:flex;align-items:center;gap:4px;}
.prof-meta a{color:var(--navy);text-decoration:none;}
.prof-actions{display:flex;gap:6px;flex-shrink:0;}

/* INFO GRID */
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px;}
.info-card{background:#fff;border:1px solid var(--g200);border-radius:10px;padding:16px 18px;}
.info-card-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--g400);margin-bottom:10px;}
.info-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--g50);}
.info-row:last-child{border-bottom:none;}
.info-lbl{font-size:13px;color:var(--g500);}
.info-val{font-size:13px;font-weight:600;color:var(--g800);}
.info-val.muted{color:var(--g400);}
.stage-badge{display:inline-flex;align-items:center;gap:5px;font-size:13px;font-weight:700;padding:4px 12px;border-radius:8px;background:var(--navy-light);color:var(--navy);}
.days-badge{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;padding:2px 7px;border-radius:12px;}
.days-badge.overdue{background:var(--red-light);color:var(--red);}
.days-badge.ok{background:var(--green-light);color:var(--green);}

/* TIMELINE */
.timeline-card{background:#fff;border:1px solid var(--g200);border-radius:10px;padding:20px;}
.timeline-title{font-size:15px;font-weight:700;color:var(--g900);margin-bottom:16px;}
.flow-stage{position:relative;padding-left:36px;padding-bottom:4px;}
.flow-stage::before{content:'';position:absolute;left:13px;top:28px;bottom:0;width:2px;background:var(--g200);}
.flow-stage:last-child::before{display:none;}
.flow-dot{position:absolute;left:5px;top:5px;width:18px;height:18px;border-radius:50%;border:3px solid var(--g300);background:#fff;z-index:2;}
.flow-dot.done{background:var(--green);border-color:var(--green);}
.flow-dot.done::after{content:'';color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;height:100%;}
.flow-dot.current{background:var(--navy);border-color:var(--navy);box-shadow:0 0 0 3px rgba(0,63,135,.2);}
.flow-dot.current::after{content:'';width:5px;height:5px;background:#fff;border-radius:50%;display:block;margin:3.5px auto;}
.flow-head{display:flex;align-items:center;gap:8px;margin-bottom:4px;}
.flow-label{font-size:13px;font-weight:700;color:var(--g900);}
.flow-label.pending{color:var(--g400);}
.flow-date{font-size:11px;color:var(--g400);font-family:'JetBrains Mono',monospace;}
.flow-dur{font-size:10px;font-weight:600;padding:2px 7px;border-radius:10px;}
.flow-dur.fast{background:var(--green-light);color:var(--green);}
.flow-dur.slow{background:var(--gold-light);color:var(--gold);}
.flow-dur.overdue{background:var(--red-light);color:var(--red);}
.flow-events{margin:6px 0 14px;list-style:none;}
.flow-event{display:flex;align-items:flex-start;gap:6px;padding:4px 8px;border-radius:5px;font-size:12px;color:var(--g600);}
.flow-event:hover{background:var(--g50);}
.fe-icon{flex-shrink:0;font-size:13px;margin-top:1px;}
.fe-text{flex:1;line-height:1.3;}
.fe-date{flex-shrink:0;font-size:10px;color:var(--g400);font-family:'JetBrains Mono',monospace;margin-top:1px;}
.flow-pending-desc{font-size:12px;color:var(--g400);padding:2px 0 14px;}

/* NEXT ACTION */
.next-action{background:var(--navy-light);border:2px solid var(--navy);border-radius:9px;padding:12px 14px;margin:6px 0 14px;display:flex;align-items:center;justify-content:space-between;gap:12px;}
.na-left{display:flex;align-items:center;gap:8px;}
.na-icon{font-size:18px;}
.na-text{font-size:12px;font-weight:600;color:var(--navy-dark);}
.na-sub{font-size:11px;color:var(--g500);margin-top:1px;}
.na-btns{display:flex;gap:5px;flex-shrink:0;}

/* MOVE STAGE */
.move-bar{display:flex;align-items:center;gap:8px;margin-top:14px;padding-top:14px;border-top:1px solid var(--g200);}
.move-bar label{font-size:13px;font-weight:600;color:var(--g600);}
.move-select{padding:5px 10px;border:1px solid var(--g200);border-radius:8px;font-size:13px;color:var(--g700);outline:none;}
.move-select:focus{border-color:var(--navy);}

/* NOTES */
.notes-area{width:100%;min-height:70px;padding:8px 10px;border:1px solid var(--g200);border-radius:8px;font-size:13px;color:var(--g700);resize:vertical;outline:none;margin-top:6px;}
.notes-area:focus{border-color:var(--navy);}
.inline-edit{border:1px solid var(--g200);border-radius:6px;padding:3px 6px;font-size:13px;color:var(--g700);background:transparent;outline:none;font-family:inherit;}
.inline-edit:focus{border-color:var(--navy);background:white;}
.missing-field{border-color:#e74c3c !important;background:#fef2f2 !important;}
.missing-field::placeholder{color:#e74c3c;font-weight:700;}
.missing-alert{background:#fef2f2;color:#e74c3c;font-size:13px;font-weight:600;padding:8px 12px;border-radius:8px;border:1px solid #fecaca;margin-top:8px;}
.compose-card{background:var(--g50);border:1px solid var(--g200);border-radius:10px;padding:14px;}
.activity-log{max-height:400px;overflow-y:auto;}
.activity-item{display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--g100);font-size:13px;}
.activity-item:last-child{border-bottom:none;}
.activity-icon{font-size:16px;flex-shrink:0;margin-top:2px;}
.activity-content{flex:1;}
.activity-action{font-weight:600;color:var(--g700);}
.activity-details{color:var(--g500);margin-top:2px;white-space:pre-wrap;word-break:break-word;}
.activity-date{color:var(--g400);font-size:11px;flex-shrink:0;}
.date-edit{border:1px solid var(--g200);border-radius:6px;padding:3px 6px;font-size:12px;color:var(--g700);background:transparent;outline:none;cursor:pointer;}
.date-edit:focus{border-color:var(--navy);background:white;}

/* MODAL */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:200;opacity:0;pointer-events:none;transition:opacity .2s;}
.modal-bg.visible{opacity:1;pointer-events:all;}
.modal{background:#fff;border-radius:14px;width:500px;max-height:85vh;overflow-y:auto;box-shadow:0 10px 15px rgba(0,0,0,.1);}
.modal-head{padding:18px 20px;border-bottom:1px solid var(--g200);display:flex;align-items:center;justify-content:space-between;}
.modal-head h3{font-size:15px;font-weight:700;}
.modal-close{width:28px;height:28px;border-radius:6px;border:none;background:var(--g100);font-size:14px;display:flex;align-items:center;justify-content:center;}
.modal-body{padding:20px;}
.modal-foot{padding:14px 20px;border-top:1px solid var(--g200);display:flex;gap:6px;justify-content:flex-end;}

/* FORM */
.form-row{margin-bottom:14px;}
.form-label{display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--g500);margin-bottom:4px;}
.form-input{width:100%;padding:8px 10px;border:1px solid var(--g200);border-radius:8px;font-size:13px;outline:none;}
.form-input:focus{border-color:var(--navy);}
.form-row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}

/* EMPTY STATE */
.empty{text-align:center;padding:60px 20px;color:var(--g400);}
.empty-icon{font-size:42px;margin-bottom:10px;}

/* STATUS PILLS */
.pill{display:inline-flex;align-items:center;gap:3px;padding:3px 8px;border-radius:20px;font-size:11px;font-weight:600;}
.pill.overdue{background:var(--red-light);color:var(--red);}
.pill.due_today{background:var(--gold-light);color:var(--gold);}
.pill.on_track{background:var(--green-light);color:var(--green);}
.pill.responded{background:var(--navy-light);color:var(--navy);}
.pill.needs_intro{background:var(--g100);color:var(--g500);}

/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:var(--g900);color:#fff;padding:10px 18px;border-radius:10px;font-size:13px;font-weight:600;z-index:300;opacity:0;transform:translateY(10px);transition:all .3s;pointer-events:none;}
.toast.show{opacity:1;transform:translateY(0);}

@media(max-width:900px){.app{grid-template-columns:1fr;}.sidebar{display:none;}}
</style>
</head>
<body>

<div class="topnav">
  <span class="topnav-brand"> MCL Client Manager</span>
  <div class="topnav-right">
    <button class="btn btn-outline" style="color:#fff;border-color:rgba(255,255,255,0.3);font-size:12px;padding:4px 12px;" onclick="manualSync()"> Sync Sheet</button>
    <span class="badge-alert" id="overdueGlobal">0 overdue</span>
  </div>
</div>

<div class="app">
  <div class="sidebar">
    <div class="sb-section" id="stagesContainer"></div>
    <div class="sb-section">
      <div class="sb-title" id="stageClientsTitle">Clients</div>
      <input class="search-box" type="text" placeholder="Search clients..." id="searchInput" oninput="filterClients()">
      <ul class="client-list" id="clientList"></ul>
      <button class="add-btn" onclick="openAddModal()">+ Add Client</button>
    </div>
  </div>
  <div class="main" id="mainPanel">
    <div class="empty">
      <div class="empty-icon"></div>
      <p>Select a client from the sidebar to view their profile</p>
    </div>
  </div>
</div>

<!-- ADD CLIENT MODAL -->
<div class="modal-bg" id="addModal">
  <div class="modal">
    <div class="modal-head"><h3>Add New Client</h3><button class="modal-close" onclick="closeModal('addModal')"></button></div>
    <div class="modal-body">
      <div class="form-row"><label class="form-label">Full Name *</label><input class="form-input" id="addName"></div>
      <div class="form-row-2">
        <div class="form-row"><label class="form-label">Email</label><input class="form-input" id="addEmail" type="email"></div>
        <div class="form-row"><label class="form-label">Phone</label><input class="form-input" id="addPhone"></div>
      </div>
      <div class="form-row-2">
        <div class="form-row"><label class="form-label">Pipedrive ID</label><input class="form-input" id="addPipedrive"></div>
        <div class="form-row"><label class="form-label">Assigned To</label>
          <select class="form-input" id="addAssigned">
            <option value="">Select...</option>
            <option>Eric De La Rosa</option>
            <option>Cindy</option>
            <option>Carlos Salguera</option>
            <option>Kimberly Sanchez</option>
          </select>
        </div>
      </div>
      <div class="form-row-2">
        <div class="form-row"><label class="form-label">Starting Stage</label>
          <select class="form-input" id="addStage">
            <option value="need_to_call"> Need to Call</option>
            <option value="lvm"> LVM</option>
            <option value="contacted"> Contacted</option>
            <option value="waiting_mcl"> Waiting on MCL</option>
            <option value="packet_sent"> Packet Sent</option>
          </select>
        </div>
        <div class="form-row"><label class="form-label">Intro Type</label>
          <select class="form-input" id="addIntroType">
            <option value="no_answer">No Answer</option>
            <option value="lvm">Left Voicemail</option>
            <option value="spoke">Spoke</option>
          </select>
        </div>
      </div>
      <div class="form-row"><label class="form-label">Notes</label><textarea class="form-input" id="addNotes" rows="2"></textarea></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal('addModal')">Cancel</button>
      <button class="btn btn-navy" onclick="addClient()">Add Client </button>
    </div>
  </div>
</div>

<!-- SEND EMAIL MODAL -->
<div class="modal-bg" id="sendModal">
  <div class="modal">
    <div class="modal-head"><h3 id="sendModalTitle">Send Follow-up</h3><button class="modal-close" onclick="closeModal('sendModal')"></button></div>
    <div class="modal-body">
      <div class="form-row"><label class="form-label">Template</label><div id="sendTemplateInfo" style="font-size:13px;color:var(--g700);padding:8px 10px;background:var(--g50);border-radius:8px;"></div></div>
      <div class="form-row"><label class="form-label">Subject</label><div id="sendSubject" style="font-size:13px;color:var(--g700);padding:8px 10px;background:var(--g50);border-radius:8px;"></div></div>
      <div class="form-row"><label class="form-label">Preview</label><div id="sendPreview" style="font-size:13px;color:var(--g700);padding:12px;background:var(--g50);border-radius:8px;max-height:180px;overflow-y:auto;line-height:1.5;"></div></div>
    </div>
    <div class="modal-foot" style="display:flex;gap:8px;justify-content:flex-end;">
      <button class="btn btn-outline" onclick="closeModal('sendModal')">Cancel</button>
      <button class="btn btn-navy" onclick="confirmSend('email')"> Email Only</button>
      <button class="btn btn-green" onclick="confirmSend('sms')"> Text Only</button>
      <button class="btn btn-gold" onclick="confirmSend('both')"> Send Both</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// 
// CONFIG - UPDATE THESE WITH YOUR SUPABASE CREDENTIALS
// 
const SUPABASE_URL = 'https://ffhjkrpflhyrhekzczal.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZmaGprcnBmbGh5cmhla3pjemFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NTU1NDIsImV4cCI6MjA4NjAzMTU0Mn0.Lg7CfMP6_BQYwAPWhmeXQhihtv8kir1ZreGTurjG-DA'; // Get from Supabase  Settings  API  anon public key
const SEND_EMAIL_URL = 'https://stupendous-melomakarona-97abc8.netlify.app/.netlify/functions/send-email';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// 
// STATE
// 
let clients = [];
let templates = [];
let currentStage = 'need_to_call';
let currentClientId = null;
let pendingSend = null;

const STAGES = [
  { key: 'need_to_call', icon: '&#128222;', label: 'Need to Call' },
  { key: 'lvm', icon: '&#128222;', label: 'LVM' },
  { key: 'contacted', icon: '&#128172;', label: 'Contacted' },
  { key: 'waiting_mcl', icon: '&#9203;', label: 'Waiting on MCL' },
  { key: 'packet_sent', icon: '&#128236;', label: 'Packet Sent' },
  { key: 'disputes_mailed', icon: '&#128238;', label: 'Disputes Mailed' },
  { key: 'waiting_reports', icon: '&#128202;', label: 'Waiting on Reports' },
  { key: 'litigation', icon: '&#9878;', label: 'Litigation ($500)' },
  { key: 'won', icon: '&#9989;', label: 'Won' },
  { key: 'lost', icon: '&#10060;', label: 'Lost' },
];

const STAGE_ICONS = { need_to_call:'&#128222;', lvm:'&#128222;', contacted:'&#128172;', waiting_mcl:'&#9203;', packet_sent:'&#128236;', disputes_mailed:'&#128238;', waiting_reports:'&#128202;', litigation:'&#9878;', won:'&#9989;', lost:'&#10060;' };

// Follow-up days per stage (null = no auto follow-up)
const STAGE_FU_DAYS = { lvm: 2, contacted: 2, packet_sent: 4, waiting_reports: 2 };

// Template key mapping per stage
function getTemplateKeys(stage, lastFu) {
  const map = {
    lvm: { none:'intro_email_no_answer', intro:'fu1_email_no_answer', fu1:'fu2_email_no_answer', fu2:'fu3_email_no_answer' },
    contacted: { none:'fu1_email_contacted', intro:'fu1_email_contacted', fu1:'fu2_email_contacted', fu2:'fu3_email_contacted', fu3:'fu4_email_contacted' },
    packet_sent: { none:'intro_email_mailing', intro:'fu1_email_mailing', fu1:'fu2_email_mailing', fu2:'fu3_email_mailing' },
    waiting_reports: { none:'followup_31day_email', intro:'fu2_email_reports', fu1:'fu2_email_reports', fu2:'fu3_email_reports', fu3:'fu4_email_reports' },
  };
  const smsMap = {
    lvm: { none:'intro_text_no_answer', intro:'fu1_text_no_answer', fu1:'fu2_text_no_answer', fu2:'fu3_text_no_answer' },
    contacted: { none:'fu1_text_contacted', intro:'fu1_text_contacted', fu1:'fu2_text_contacted', fu2:'fu3_text_contacted', fu3:'fu4_text_contacted' },
    packet_sent: { none:'intro_text_mailing', intro:'fu1_text_mailing', fu1:'fu2_text_mailing', fu2:'fu3_text_mailing' },
    waiting_reports: { none:'followup_31day_text', intro:'fu2_text_reports', fu1:'fu2_text_reports', fu2:'fu3_text_reports', fu3:'fu4_text_reports' },
  };
  const stageMap = map[stage] || {};
  const smsStageMap = smsMap[stage] || {};
  return { email: stageMap[lastFu] || null, sms: smsStageMap[lastFu] || null };
}

// 
// DATA LOADING
// 
async function loadData() {
  const [cRes, tRes] = await Promise.all([
    sb.from('mcl_client_status').select('*').order('days_since_contact', { ascending: false, nullsFirst: true }),
    sb.from('templates').select('key, name, type, subject, body, trigger_stage')
  ]);
  if (cRes.data) clients = cRes.data;
  if (tRes.data) templates = tRes.data;
  renderStages();
  renderClientList();
  updateOverdueBadge();
  if (currentClientId) renderProfile(currentClientId);
}

async function manualSync() {
  toast('Syncing sheet...');
  try {
    const res = await fetch('/.netlify/functions/sync-sheet');
    const data = await res.json();
    if (data.error) { toast('Sync error: ' + data.error); return; }
    toast('Sync done: '+data.new_inserted+' new, '+(data.updated||0)+' updated');
    await loadData();
  } catch (e) { toast('Sync failed: ' + e.message); }
}

// 
// RENDER STAGES
// 
function renderStages() {
  const container = document.getElementById('stagesContainer');
  container.innerHTML = '<div class="sb-title">Pipeline</div>';
  STAGES.forEach(s => {
    const stageClients = clients.filter(c => {
      if (s.key === 'won') return c.outcome === 'won';
      if (s.key === 'lost') return c.outcome === 'lost';
      if (s.key === 'litigation') return c.outcome === 'litigation';
      return c.stage === s.key && !c.outcome;
    });
    const overdue = stageClients.filter(c => c.follow_up_status === 'overdue').length;
    const btn = document.createElement('button');
    btn.className = 'stage-btn' + (s.key === currentStage ? ' active' : '');
    btn.onclick = () => { currentStage = s.key; currentClientId = null; renderStages(); renderClientList(); renderEmptyMain(); };
    btn.innerHTML = `
      <span class="sb-left"><span class="sb-icon">${s.icon}</span><span class="sb-label">${s.label}</span></span>
      <span class="sb-right">
        <span class="sb-count">${stageClients.length}</span>
        ${overdue > 0 ? `<span class="sb-overdue">${overdue}</span>` : ''}
      </span>`;
    container.appendChild(btn);
  });
}

// 
// RENDER CLIENT LIST
// 
function renderClientList() {
  const stageClients = getStageClients();
  document.getElementById('stageClientsTitle').textContent = `${STAGE_ICONS[currentStage]||''} ${STAGES.find(s=>s.key===currentStage)?.label||'Clients'}  ${stageClients.length}`;
  renderFilteredClients(stageClients);
}

function getStageClients() {
  let list;
  if (currentStage === 'won') list = clients.filter(c => c.outcome === 'won');
  else if (currentStage === 'lost') list = clients.filter(c => c.outcome === 'lost');
  else if (currentStage === 'litigation') list = clients.filter(c => c.outcome === 'litigation');
  else list = clients.filter(c => c.stage === currentStage && !c.outcome);
  // Sort: overdue first, then due_today, then on_track
  const priority = { overdue: 0, due_today: 1, needs_intro: 2, on_track: 3, responded: 4, resolved: 5 };
  list.sort((a, b) => (priority[a.follow_up_status] || 9) - (priority[b.follow_up_status] || 9) || (b.days_since_contact || 0) - (a.days_since_contact || 0));
  return list;
}

function renderFilteredClients(list, skipFilter) {
  if (!skipFilter) {
    const q = document.getElementById('searchInput').value.toLowerCase();
    if (q) list = list.filter(c => c.name.toLowerCase().includes(q) || (c.email||'').toLowerCase().includes(q));
  }
  const ul = document.getElementById('clientList');
  ul.innerHTML = '';
  if (!list.length) { ul.innerHTML = '<div style="text-align:center;padding:20px;color:var(--g400);font-size:13px;">No clients</div>'; return; }
  list.forEach(c => {
    const li = document.createElement('li');
    li.className = 'client-item' + (c.id === currentClientId ? ' active' : '');
    li.onclick = () => { currentClientId = c.id; currentStage = c.outcome || c.stage; renderStages(); renderClientList(); renderProfile(c.id); };
    const fuLabel = c.last_followup === 'none' ? 'No contact' : c.last_followup === 'intro' ? 'Intro sent' : `FU #${c.last_followup.replace('fu','')}`;
    const daysLabel = c.days_since_contact != null ? `${c.days_since_contact}d ago` : 'never';
    const stageIcon = STAGE_ICONS[c.outcome || c.stage] || '';
    const stageName = STAGES.find(s => s.key === (c.outcome || c.stage))?.label || '';
    li.innerHTML = `
      <div class="ci-left"><div class="ci-name">${c.name}</div><div class="ci-sub">${stageIcon} ${stageName}  ${fuLabel}  ${daysLabel}</div></div>
      <div><span class="dot ${c.follow_up_status}"></span></div>`;
    ul.appendChild(li);
  });
}

function filterClients() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  if (q) {
    // Search across ALL clients, not just current stage
    const allMatches = clients.filter(c => c.name.toLowerCase().includes(q) || (c.email||'').toLowerCase().includes(q) || (c.phone||'').includes(q));
    document.getElementById('stageClientsTitle').textContent = ` Search  ${allMatches.length} results`;
    renderFilteredClients(allMatches, true);
  } else {
    renderClientList();
  }
}

// 
// RENDER PROFILE
// 
function renderProfile(clientId) {
  const c = clients.find(x => x.id === clientId);
  if (!c) return;
  const main = document.getElementById('mainPanel');

  const stageLabel = STAGES.find(s=>s.key===c.stage)?.label || c.stage;
  const stageIcon = STAGE_ICONS[c.stage] || '';
  const daysInStage = c.days_in_stage || 0;

  // Determine next action
  const lastFu = c.last_followup || 'none';
  const fuKeys = getTemplateKeys(c.stage, lastFu);
  const hasNextTemplate = fuKeys.email != null;
  const allSent = !hasNextTemplate;

  main.innerHTML = `
    <!-- PROFILE HEADER -->
    <div class="prof-header">
      <div>
        <div class="prof-name">${c.name}</div>
        <div class="prof-meta">
          <span> <input class="inline-edit ${!c.email ? 'missing-field' : ''}" id="editEmail" value="${c.email || ''}" placeholder=" ADD EMAIL" onblur="saveField('${c.id}','email',this.value)" style="width:220px;"></span>
          <span> <input class="inline-edit ${!c.phone ? 'missing-field' : ''}" id="editPhone" value="${c.phone || ''}" placeholder=" ADD PHONE" onblur="saveField('${c.id}','phone',this.value)" style="width:140px;"></span>
          ${c.pipedrive_id ? `<span> PD #${c.pipedrive_id}</span>` : ''}
        </div>
        ${!c.email || !c.phone ? `<div class="missing-alert"> ${!c.email && !c.phone ? 'Email and phone number are missing' : !c.email ? 'Email is missing' : 'Phone number is missing'}  add before contacting</div>` : ''}
      </div>
      <div class="prof-actions">
        ${!c.responded && !c.outcome ? `<button class="btn btn-gold btn-sm" onclick="markResponded('${c.id}')"> Responded</button>` : ''}
        ${!c.outcome ? `<button class="btn btn-green btn-sm" onclick="markOutcome('${c.id}','won')"> Won</button>` : ''}
        ${!c.outcome ? `<button class="btn btn-outline btn-sm" onclick="markOutcome('${c.id}','litigation')"> Litigation</button>` : ''}
        ${!c.outcome ? `<button class="btn btn-red btn-sm" onclick="markOutcome('${c.id}','lost')"> Lost</button>` : ''}
        <button class="btn btn-outline btn-sm" style="color:var(--red);border-color:var(--red);margin-left:8px;" onclick="deleteClient('${c.id}','${c.name.replace(/'/g,"\\'")}')"> Delete</button>
      </div>
    </div>

    <!-- INFO CARDS -->
    <div class="info-grid">
      <div class="info-card">
        <div class="info-card-title">Client Details</div>
        <div class="info-row"><span class="info-lbl">Current Stage</span><span class="stage-badge">${stageIcon} ${stageLabel}</span></div>
        <div class="info-row"><span class="info-lbl">Time in Stage</span><span class="days-badge ${daysInStage > 10 ? 'overdue' : 'ok'}">${daysInStage} days</span></div>
        <div class="info-row"><span class="info-lbl">Assigned To</span><span class="info-val">${c.assigned_to || ''}</span></div>
        <div class="info-row"><span class="info-lbl">Intro Type</span><span class="info-val">${c.intro_type === 'lvm' ? 'Left Voicemail' : c.intro_type === 'spoke' ? 'Spoke' : 'No Answer'}</span></div>
        <div class="info-row"><span class="info-lbl">Credit Error</span><span class="info-val"><input class="inline-edit" value="${c.credit_error || ''}" placeholder="Enter violation..." onblur="saveField('${c.id}','credit_error',this.value)" style="width:100%;"></span></div>
        <div class="info-row"><span class="info-lbl">Follow-up Status</span><span class="pill ${c.follow_up_status}">${statusLabel(c.follow_up_status)}</span></div>
      </div>
      <div class="info-card">
        <div class="info-card-title">Key Dates</div>
        <div class="info-row"><span class="info-lbl">Lead Created</span><span class="info-val">${fmtDate(c.created_at)}</span></div>
        <div class="info-row"><span class="info-lbl">Intro Sent</span><span class="info-val ${!c.intro_sent_at?'muted':''}">${c.intro_sent_at ? fmtDate(c.intro_sent_at) : ' not yet'}</span></div>
        <div class="info-row"><span class="info-lbl">Client Responded</span><span class="info-val ${!c.responded_at?'muted':''}">${c.responded_at ? fmtDate(c.responded_at) : ' not yet'}</span></div>
        <div class="info-row"><span class="info-lbl">Packet Sent to Client</span><span class="info-val"><input type="date" class="date-edit" value="${c.disputes_mailed_to_client || ''}" onchange="saveField('${c.id}','disputes_mailed_to_client',this.value)"></span></div>
        <div class="info-row"><span class="info-lbl">Disputes Mailed to CRA</span><span class="info-val"><input type="date" class="date-edit" value="${c.disputes_mailed_to_cra || ''}" onchange="saveField('${c.id}','disputes_mailed_to_cra',this.value)"></span></div>
        <div class="info-row"><span class="info-lbl">Round Over Date</span><span class="info-val">${c.round_over_date ? `<span class="days-badge ${c.days_until_round_over <= 0 ? 'overdue' : 'ok'}">${c.round_over_date} ${c.days_until_round_over > 0 ? '(' + c.days_until_round_over + ' days left)' : c.days_until_round_over === 0 ? '(TODAY!)' : '(ROUND OVER)'}</span>` : '<input type="date" class="date-edit" value="" onchange="saveField(\'' + c.id + '\',\'round_over_date\',this.value)">'}</span></div>
        <div class="info-row"><span class="info-lbl">Outcome</span><span class="info-val ${!c.outcome?'muted':''}">${c.outcome ? c.outcome.toUpperCase() : ' pending'}</span></div>
      </div>
    </div>

    <!-- TIMELINE -->
    <div class="timeline-card">
      <div class="timeline-title"> Follow-up Timeline</div>
      <div class="flow">
        ${renderTimeline(c)}
      </div>
      ${!c.outcome ? `
      <div class="move-bar">
        <label>Move to:</label>
        <select class="move-select" id="moveSelect">
          <option value="need_to_call"> Need to Call</option>
          <option value="lvm"> LVM</option>
          <option value="contacted"> Contacted</option>
          <option value="waiting_mcl"> Waiting on MCL</option>
          <option value="packet_sent"> Packet Sent</option>
          <option value="disputes_mailed"> Disputes Mailed</option>
          <option value="waiting_reports"> Waiting on Reports</option>
        </select>
        <button class="btn btn-navy btn-sm" onclick="moveStage('${c.id}')">Move </button>
        <button class="btn btn-green btn-sm" style="margin-left:4px;" onclick="markOutcome('${c.id}','won')"> Won</button>
        <button class="btn btn-outline btn-sm" style="margin-left:4px;" onclick="markOutcome('${c.id}','litigation')"> Litigation</button>
      </div>` : ''}
    </div>

    <!-- NOTES -->
    <div style="margin-top:16px;">
      <div class="form-label">Notes</div>
      <textarea class="notes-area" id="notesArea" onblur="saveNotes('${c.id}')" placeholder="Add notes...">${c.notes || ''}</textarea>
    </div>

    ${!c.outcome ? `
    <div class="compose-card" style="margin-top:16px;">
      <div class="form-label"> Send Manual Message</div>
      <div style="margin-bottom:8px;">
        <input class="form-input" id="composeSubject" placeholder="Subject (email only)" style="margin-bottom:6px;">
        <textarea class="notes-area" id="composeBody" placeholder="Type your message here..." style="min-height:80px;"></textarea>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-navy btn-sm" onclick="this.disabled=true;this.textContent='Sending...';sendManualEmail('${c.id}')"> Send Email</button>
        <button class="btn btn-green btn-sm" onclick="this.disabled=true;this.textContent='Sending...';sendManualText('${c.id}')"> Send Text</button>
        <button class="btn btn-outline btn-sm" onclick="this.disabled=true;this.textContent='Sending...';sendManualBoth('${c.id}')">+ Send Both</button>
      </div>
    </div>` : ''}

    <div style="margin-top:16px;">
      <div class="form-label"> Activity History</div>
      <div id="activityLog" class="activity-log">Loading...</div>
    </div>
  `;

  // Set move select to current stage
  const sel = document.getElementById('moveSelect');
  if (sel) sel.value = c.stage;
  loadActivityLog(c.id);
}

function renderTimeline(c) {
  let html = '';
  const events = [];
  
  // Intro
  if (c.intro_sent_at) events.push({ type: 'intro', label: 'Intro email + SMS sent', date: c.intro_sent_at, icon: '' });
  if (c.fu1_sent_at) events.push({ type: 'fu1', label: 'Follow-up #1 sent', date: c.fu1_sent_at, icon: '' });
  if (c.fu2_sent_at) events.push({ type: 'fu2', label: 'Follow-up #2 sent', date: c.fu2_sent_at, icon: '' });
  if (c.fu3_sent_at) events.push({ type: 'fu3', label: 'Follow-up #3 sent', date: c.fu3_sent_at, icon: '' });
  if (c.fu4_sent_at) events.push({ type: 'fu4', label: 'Follow-up #4 sent', date: c.fu4_sent_at, icon: '' });

  // Current stage
  const stageIcon = STAGE_ICONS[c.stage];
  const stageLabel = STAGES.find(s=>s.key===c.stage)?.label || c.stage;
  const daysInStage = c.days_in_stage || 0;
  const durClass = daysInStage > 14 ? 'overdue' : daysInStage > 7 ? 'slow' : 'fast';

  html += `<div class="flow-stage">
    <div class="flow-dot current"></div>
    <div class="flow-head">
      <span class="flow-label">${stageIcon} ${stageLabel}</span>
      <span class="flow-date">${fmtDate(c.intro_sent_at || c.created_at)}  now</span>
      <span class="flow-dur ${durClass}">${daysInStage} days</span>
    </div>
    <ul class="flow-events">
      ${events.length === 0 ? `<li class="flow-event"><span class="fe-icon"></span><span class="fe-text">No follow-ups sent yet</span></li>` : ''}
      ${events.map(e => `<li class="flow-event"><span class="fe-icon">${e.icon}</span><span class="fe-text">${e.label}</span><span class="fe-date">${fmtDate(e.date)}</span></li>`).join('')}
    </ul>`;

  // Next action
  if (!c.responded && !c.outcome) {
    // Stage-specific actions
    if (c.stage === 'need_to_call') {
      html += `<div class="next-action" style="border-color:var(--navy);background:var(--navy-light);">
        <div class="na-left"><span class="na-icon"></span>
          <div><div class="na-text">Call this client about the credit error</div><div class="na-sub">${c.credit_error || 'Check sheet for details'}</div></div>
        </div>
        <div class="na-btns">
          <button class="btn btn-navy btn-sm" onclick="moveStage('${c.id}','lvm')"> No Answer  LVM</button>
          <button class="btn btn-green btn-sm" onclick="moveStage('${c.id}','contacted')"> Spoke  Contacted</button>
        </div>
      </div>`;
    } else if (c.stage === 'waiting_mcl') {
      html += `<div class="next-action" style="border-color:var(--gold);background:#fef9e7;">
        <div class="na-left"><span class="na-icon"></span>
          <div><div class="na-text">Waiting on McCarthy Law to contact client</div><div class="na-sub">Move to Packet Sent when MCL sends the packet</div></div>
        </div>
        <div class="na-btns">
          <button class="btn btn-navy btn-sm" onclick="moveStage('${c.id}','packet_sent')"> Packet Sent</button>
        </div>
      </div>`;
    } else if (c.stage === 'disputes_mailed') {
      const daysLeft = c.days_until_round_over;
      const roundText = daysLeft === null ? 'Enter "Disputes Mailed to CRA" date to start 31-day clock' : daysLeft > 0 ? ' ' + daysLeft + ' days until round is over' : daysLeft === 0 ? ' Round ends TODAY' : ' ROUND OVER  move to Waiting on Reports';
      html += `<div class="next-action" style="border-color:var(--gold);background:#fef9e7;">
        <div class="na-left"><span class="na-icon"></span>
          <div><div class="na-text">Disputes mailed  31-day clock running</div><div class="na-sub">${roundText}</div></div>
        </div>
        ${daysLeft !== null && daysLeft <= 0 ? `<div class="na-btns"><button class="btn btn-navy btn-sm" onclick="moveStage('${c.id}','waiting_reports')"> Move to Waiting on Reports</button></div>` : ''}
      </div>`;
    } else {
      const lastFu = c.last_followup || 'none';
      const fuKeys = getTemplateKeys(c.stage, lastFu);
      if (fuKeys.email) {
        const tpl = templates.find(t => t.key === fuKeys.email);
        const nextNum = lastFu === 'none' ? 'Intro' : `FU #${parseInt(lastFu.replace('fu','')) + 1}`;
        const fuDays = STAGE_FU_DAYS[c.stage] || 2;
        const dueText = c.follow_up_status === 'overdue' ? ` OVERDUE  ${c.days_since_contact} days since last contact` : c.follow_up_status === 'due_today' ? ' Due today' : ` Due in ${fuDays - (c.days_since_contact || 0)} days`;
        html += `<div class="next-action">
          <div class="na-left"><span class="na-icon">${c.follow_up_status === 'overdue' ? '' : ''}</span>
            <div><div class="na-text">Next: Send ${nextNum}${tpl ? `  "${tpl.subject}"` : ''}</div><div class="na-sub">${dueText}</div></div>
          </div>
          <div class="na-btns">
            <button class="btn btn-navy btn-sm" onclick="openSendModal('${c.id}','email')"> Send Email</button>
            <button class="btn btn-green btn-sm" onclick="openSendModal('${c.id}','sms')"> Send Text</button>
          </div>
        </div>`;
      } else {
        html += `<div class="next-action">
          <div class="na-left"><span class="na-icon"></span>
            <div><div class="na-text">All follow-ups sent for this stage</div><div class="na-sub">Consider calling again or moving to next stage</div></div>
          </div>
        </div>`;
      }
    }
  } else if (c.responded) {
    html += `<div class="next-action" style="border-color:var(--green);background:var(--green-light);">
      <div class="na-left"><span class="na-icon"></span>
        <div><div class="na-text" style="color:var(--green);">Client responded ${c.responded_at ? 'on ' + fmtDate(c.responded_at) : ''}</div></div>
      </div>
    </div>`;
  }
  html += `</div>`;

  // Pending stages
  const allStages = ['need_to_call','lvm','contacted','waiting_mcl','packet_sent','disputes_mailed','waiting_reports'];
  const currentIdx = allStages.indexOf(c.stage);
  for (let i = currentIdx + 1; i < allStages.length; i++) {
    const ps = STAGES.find(s => s.key === allStages[i]);
    const descs = {
      lvm: 'No answer  leave voicemail, follow up every 2 days',
      contacted: 'Spoke to client  send intro email, waiting for "Yes"',
      waiting_mcl: 'Client replied "Yes"  McCarthy Law contacting them',
      packet_sent: 'MCL sent packet  follow up in 4 days to confirm receipt',
      disputes_mailed: 'Client mailed disputes  31-day clock starts',
      waiting_reports: 'Round over  request updated credit reports',
    };
    html += `<div class="flow-stage"><div class="flow-dot"></div>
      <div class="flow-head"><span class="flow-label pending">${ps.icon} ${ps.label}</span></div>
      <div class="flow-pending-desc">${descs[allStages[i]] || ''}</div></div>`;
  }
  html += `<div class="flow-stage"><div class="flow-dot"></div>
    <div class="flow-head"><span class="flow-label pending"> Won /  Litigation</span></div>
    <div class="flow-pending-desc">Error corrected = Won | Not corrected = Litigation ($500)</div></div>`;

  return html;
}

function renderEmptyMain() {
  document.getElementById('mainPanel').innerHTML = `<div class="empty"><div class="empty-icon"></div><p>Select a client from the sidebar</p></div>`;
}

// 
// ACTIONS
// 
async function addClient() {
  const name = document.getElementById('addName').value.trim();
  if (!name) { toast('Name is required'); return; }
  const { data, error } = await sb.from('mcl_clients').insert({
    name,
    email: document.getElementById('addEmail').value.trim() || null,
    phone: document.getElementById('addPhone').value.trim() || null,
    pipedrive_id: document.getElementById('addPipedrive').value.trim() || null,
    assigned_to: document.getElementById('addAssigned').value || null,
    stage: document.getElementById('addStage').value,
    intro_type: document.getElementById('addIntroType').value,
    notes: document.getElementById('addNotes').value.trim() || null,
  }).select().single();
  if (error) { toast('Error: ' + error.message); return; }
  closeModal('addModal');
  toast('Client added ');
  currentStage = data.stage;
  currentClientId = data.id;
  await loadData();
}

async function markResponded(id) {
  await sb.from('mcl_clients').update({ responded: true, responded_at: new Date().toISOString() }).eq('id', id);
  await sb.from('mcl_activity_log').insert({ client_id: id, action: 'responded', details: 'Manually marked as responded' });
  toast('Marked as responded ');
  await loadData();
}

async function markOutcome(id, outcome) {
  await sb.from('mcl_clients').update({ outcome, outcome_at: new Date().toISOString(), stage: outcome }).eq('id', id);
  await sb.from('mcl_activity_log').insert({ client_id: id, action: outcome, details: `Marked as ${outcome}` });
  toast(`Marked as ${outcome} `);
  await loadData();
}

async function moveStage(id, targetStage) {
  const newStage = targetStage || document.getElementById('moveSelect').value;
  const c = clients.find(x => x.id === id);
  if (!c || c.stage === newStage) return;
  
  // Reset follow-up tracking when moving to new stage
  await sb.from('mcl_clients').update({
    stage: newStage,
    intro_sent_at: null, fu1_sent_at: null, fu2_sent_at: null, fu3_sent_at: null, fu4_sent_at: null,
    responded: false, responded_at: null,
  }).eq('id', id);
  await sb.from('mcl_activity_log').insert({ client_id: id, action: 'stage_changed', details: `Moved from ${c.stage} to ${newStage}` });
  const label = STAGES.find(s => s.key === newStage)?.label || newStage;
  toast(`Moved to ${label} `);
  currentStage = newStage;
  await loadData();
}

async function saveNotes(id) {
  const notes = document.getElementById('notesArea')?.value || '';
  await sb.from('mcl_clients').update({ notes }).eq('id', id);
}


async function loadActivityLog(clientId) {
  var el = document.getElementById('activityLog');
  if (!el) return;
  var resp = await sb.from('mcl_activity_log').select('*').eq('client_id', clientId).order('created_at', { ascending: false }).limit(50);
  var data = resp.data;
  if (!data || data.length === 0) { el.innerHTML = '<div style="text-align:center;padding:12px;color:var(--g400);font-size:13px;">No activity yet</div>'; return; }
  var icons = { email_sent:'E', sms_sent:'T', manual_email:'E', manual_sms:'T', manual_both:'ET', stage_changed:'S', responded:'R', won:'W', lost:'L', litigation:'J' };
  el.innerHTML = data.map(function(a) {
    var icon = icons[a.action] || '-';
    var label = a.action.replace(/_/g,' ');
    return '<div class="activity-item"><div class="activity-icon">[' + icon + ']</div><div class="activity-content"><div class="activity-action">' + label + '</div><div class="activity-details">' + (a.details||'') + '</div></div><div class="activity-date">' + fmtDate(a.created_at) + '</div></div>';
  }).join('');
}

async function sendManualEmail(clientId) {
    var c = clients.find(function(x){return x.id===clientId;});
  if (!c) return;
  if (!c.email) { toast('No email! Add it first.'); return; }
  var subject = document.getElementById('composeSubject').value.trim();
  var body = document.getElementById('composeBody').value.trim();
  if (!body) { toast('Write a message first'); return; }
  if (!subject) { toast('Add a subject line'); return; }
  try {
    var res = await fetch(SEND_EMAIL_URL, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to:c.email,subject:subject,body:body})});
    var data = await res.json();
    if (data.ok) {
      await sb.from('mcl_activity_log').insert({client_id:c.id,action:'manual_email',details:'Subject: '+subject+'\n'+body});
      toast('Email sent to '+c.email);
      document.getElementById('composeSubject').value=''; document.getElementById('composeBody').value='';
      loadActivityLog(c.id);
    } else { toast('Email error: '+(data.error||'unknown')); }
  } catch(e) { toast('Email failed: '+e.message); }
}

async function sendManualText(clientId) {
    var c = clients.find(function(x){return x.id===clientId;});
  if (!c) return;
  if (!c.phone) { toast('No phone! Add it first.'); return; }
  var body = document.getElementById('composeBody').value.trim();
  if (!body) { toast('Write a message first'); return; }
  try {
    var digits=(c.phone||'').replace(/[^0-9]/g,'');
    var phone=digits.length===10?'+1'+digits:digits.length===11?'+'+digits:c.phone;
    await fetch('/.netlify/functions/send-sms',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:phone,firstName:c.name.split(' ')[0],message:body,dealId:''})});
    await sb.from('mcl_activity_log').insert({client_id:c.id,action:'manual_sms',details:body});
    toast('Text sent to '+c.phone);
    document.getElementById('composeBody').value='';
    loadActivityLog(c.id);
  } catch(e) { toast('Text failed: '+e.message); }
}

async function sendManualBoth(clientId) {
    var c = clients.find(function(x){return x.id===clientId;});
  if (!c) return;
  if (!c.email) { toast('No email! Add it first.'); return; }
  if (!c.phone) { toast('No phone! Add it first.'); return; }
  var subject = document.getElementById('composeSubject').value.trim();
  var body = document.getElementById('composeBody').value.trim();
  if (!body) { toast('Write a message first'); return; }
  if (!subject) { toast('Add a subject line'); return; }
  try {
    await fetch(SEND_EMAIL_URL, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to:c.email,subject:subject,body:body})});
    var digits=(c.phone||'').replace(/[^0-9]/g,'');
    var phone=digits.length===10?'+1'+digits:digits.length===11?'+'+digits:c.phone;
    await fetch('/.netlify/functions/send-sms',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:phone,firstName:c.name.split(' ')[0],message:body,dealId:''})});
    await sb.from('mcl_activity_log').insert({client_id:c.id,action:'manual_both',details:'Subject: '+subject+'\n'+body});
    toast('Email + Text sent');
    document.getElementById('composeSubject').value=''; document.getElementById('composeBody').value='';
    loadActivityLog(c.id);
  } catch(e) { toast('Send failed: '+e.message); }
}

async function deleteClient(id, name) {
  if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;
  await sb.from('mcl_activity_log').delete().eq('client_id', id);
  await sb.from('mcl_clients').delete().eq('id', id);
  toast(`${name} deleted`);
  currentClientId = null;
  renderEmptyMain();
  await loadData();
}

async function saveField(id, field, value) {
  const update = { [field]: value || null };
  // Auto-calculate round end date: disputes mailed + 31 days
  if (field === 'disputes_mailed_to_cra' && value) {
    const mailDate = new Date(value);
    mailDate.setDate(mailDate.getDate() + 31);
    update.round_over_date = mailDate.toISOString().split('T')[0];
  }
  await sb.from('mcl_clients').update(update).eq('id', id);
  // Refresh local data
  const c = clients.find(x => x.id === id);
  if (c) { 
    c[field] = value;
    if (update.round_over_date) c.round_over_date = update.round_over_date;
  }
  toast(`${field.replace(/_/g,' ')} updated `);
  if (update.round_over_date) toast(`Round over date auto-set: ${update.round_over_date}`);
  if (currentClientId === id) renderProfile(id);
}

// 
// SEND EMAIL/SMS
// 
function openSendModal(clientId, type) {
  const c = clients.find(x => x.id === clientId);
  if (!c) return;
  const lastFu = c.last_followup || 'none';
  const fuKeys = getTemplateKeys(c.stage, lastFu);
  const tplKey = type === 'sms' ? fuKeys.sms : fuKeys.email;
  const tpl = templates.find(t => t.key === tplKey);

  if (!tpl) { toast('No template found for this step'); return; }

  const nextNum = lastFu === 'none' ? 'Intro' : `Follow-up #${parseInt(lastFu.replace('fu','')) + 1}`;
  document.getElementById('sendModalTitle').textContent = ` Send ${nextNum} to ${c.name}`;
  document.getElementById('sendTemplateInfo').textContent = `${tpl.name} (${tpl.key})`;
  document.getElementById('sendSubject').textContent = tpl.subject || '(SMS - no subject)';

  // Replace {name} in preview
  const preview = (tpl.body || '').replace(/\{name\}/g, c.name.split(' ')[0]).replace(/\{agent\}/g, c.assigned_to || 'ASAP Credit Repair');
  document.getElementById('sendPreview').innerHTML = tpl.type === 'email' ? preview : preview.replace(/\n/g, '<br>');

  pendingSend = { clientId, emailKey: fuKeys.email, smsKey: fuKeys.sms, lastFu, type };
  document.getElementById('sendModal').classList.add('visible');
}

async function confirmSend(mode) {
  if (!pendingSend) return;
  const c = clients.find(x => x.id === pendingSend.clientId);
  if (!c) return;

  const doEmail = mode === 'email' || mode === 'both';
  const doSms = mode === 'sms' || mode === 'both';

  if (doEmail && !c.email) { toast(' Cannot send email  no email address! Add it first.'); return; }
  if (doSms && !c.phone) { toast(' Cannot send text  no phone number! Add it first.'); return; }

  const emailTpl = templates.find(t => t.key === pendingSend.emailKey);
  const smsTpl = templates.find(t => t.key === pendingSend.smsKey);

  // Send email via SendGrid function
  if (doEmail && emailTpl && c.email) {
    try {
      const body = emailTpl.body.replace(/\{name\}/g, c.name.split(' ')[0]).replace(/\{agent\}/g, c.assigned_to || '');
      const res = await fetch(SEND_EMAIL_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ to: c.email, subject: emailTpl.subject, body })
      });
      const data = await res.json();
      if (data.ok) {
        await sb.from('mcl_activity_log').insert({ client_id: c.id, action: 'email_sent', template_key: emailTpl.key, details: `Sent: ${emailTpl.subject}` });
      } else {
        toast('Email error: ' + (data.error || 'unknown'));
      }
    } catch (e) { toast('Email send failed: ' + e.message); }
  }

  // Send SMS via Zapier webhook
  if (doSms && smsTpl && c.phone) {
    try {
      const smsBody = smsTpl.body.replace(/\{name\}/g, c.name.split(' ')[0]).replace(/\{agent\}/g, c.assigned_to || 'ASAP Credit Repair');
      const digits = (c.phone || '').replace(/\D/g, '');
      const phone = digits.length === 10 ? '+1' + digits : digits.length === 11 ? '+' + digits : c.phone;
      await fetch('/.netlify/functions/send-sms', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: phone, firstName: c.name.split(' ')[0], message: smsBody, dealId: c.deal_id || "" })
      });
      await sb.from('mcl_activity_log').insert({ client_id: c.id, action: 'sms_sent', template_key: smsTpl.key, details: 'Sent via Zapier' });
    } catch (e) { toast('SMS send failed: ' + e.message); }
  }

  // Update follow-up timestamps
  const lastFu = pendingSend.lastFu;
  const updateField = lastFu === 'none' ? 'intro_sent_at' : lastFu === 'intro' ? 'fu1_sent_at' : lastFu === 'fu1' ? 'fu2_sent_at' : lastFu === 'fu2' ? 'fu3_sent_at' : lastFu === 'fu3' ? 'fu4_sent_at' : null;
  if (updateField) {
    await sb.from('mcl_clients').update({ [updateField]: new Date().toISOString() }).eq('id', c.id);
  }

  closeModal('sendModal');
  const sentWhat = mode === 'both' ? 'Email + Text' : mode === 'sms' ? 'Text' : 'Email';
  toast(`${sentWhat} sent `);
  pendingSend = null;
  await loadData();
}

// 
// HELPERS
// 
function fmtDate(d) {
  if (!d) return '';
  const dt = new Date(d);
  return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function statusLabel(s) {
  return { overdue: ' Overdue', due_today: ' Due Today', on_track: ' On Track', responded: ' Responded', needs_intro: ' Needs Call', resolved: ' Resolved' }[s] || s;
}

function updateOverdueBadge() {
  const overdue = clients.filter(c => c.follow_up_status === 'overdue').length;
  document.getElementById('overdueGlobal').textContent = overdue > 0 ? `${overdue} overdue` : ' All clear';
  document.getElementById('overdueGlobal').style.background = overdue > 0 ? 'var(--red)' : 'var(--green)';
}

function openAddModal() {
  document.getElementById('addName').value = '';
  document.getElementById('addEmail').value = '';
  document.getElementById('addPhone').value = '';
  document.getElementById('addPipedrive').value = '';
  document.getElementById('addAssigned').value = '';
  document.getElementById('addStage').value = currentStage === 'won' || currentStage === 'lost' || currentStage === 'litigation' ? 'need_to_call' : currentStage;
  document.getElementById('addIntroType').value = 'no_answer';
  document.getElementById('addNotes').value = '';
  document.getElementById('addModal').classList.add('visible');
}

function closeModal(id) { document.getElementById(id).classList.remove('visible'); }

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// Click outside modal to close
document.querySelectorAll('.modal-bg').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('visible'); });
});

// 
// INIT
// 
loadData();
// Auto-refresh data every 60 seconds
setInterval(loadData, 60000);
// Auto-sync sheet every 2 minutes (pulls new clients from Google Sheet)
async function autoSync() {
  try {
    const res = await fetch('/.netlify/functions/sync-sheet');
    const data = await res.json();
    if (data.new_inserted > 0) {
      toast(` ${data.new_inserted} new client(s) synced from sheet`);
      await loadData();
    }
  } catch (e) { /* silent fail on auto-sync */ }
}
autoSync(); // run once on load
setInterval(autoSync, 120000); // then every 2 minutes
</script>
</body>
</html>

