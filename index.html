<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASAP Credit Repair - Financial Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a2235;
            --bg-card-hover: #1f2a40;
            --border-color: #2a3548;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-green: #10b981;
            --accent-green-light: #34d399;
            --accent-red: #ef4444;
            --accent-red-light: #f87171;
            --accent-blue: #3b82f6;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --accent-orange: #f97316;
            --gradient-green: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --gradient-red: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --gradient-blue: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        body { font-family: 'DM Sans', -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        .app-container { max-width: 1600px; margin: 0 auto; padding: 24px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid var(--border-color); }
        .logo-section { display: flex; align-items: center; gap: 16px; }
        .logo-icon { width: 48px; height: 48px; background: var(--gradient-green); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 20px; color: white; }
        .logo-text h1 { font-size: 24px; font-weight: 700; letter-spacing: -0.5px; }
        .logo-text span { font-size: 13px; color: var(--text-secondary); }
        .header-actions { display: flex; align-items: center; gap: 16px; }
        .sync-status { display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: var(--bg-card); border-radius: 8px; font-size: 13px; color: var(--text-secondary); }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-green); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .refresh-btn { padding: 10px 20px; background: var(--gradient-blue); border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; display: flex; align-items: center; gap: 8px; }
        .refresh-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
        .refresh-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .date-filter { display: flex; gap: 8px; margin-bottom: 24px; }
        .date-btn { padding: 8px 16px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .date-btn:hover, .date-btn.active { background: var(--bg-card-hover); color: var(--text-primary); border-color: var(--accent-blue); }
        .date-btn.active { background: rgba(59, 130, 246, 0.15); }
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px; }
        .kpi-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; position: relative; overflow: hidden; transition: all 0.3s; }
        .kpi-card:hover { background: var(--bg-card-hover); border-color: var(--accent-blue); transform: translateY(-2px); }
        .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
        .kpi-card.revenue::before { background: var(--gradient-green); }
        .kpi-card.expenses::before { background: var(--gradient-red); }
        .kpi-card.profit::before { background: var(--gradient-blue); }
        .kpi-card.margin::before { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .kpi-card.doo::before { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .kpi-label { font-size: 13px; color: var(--text-secondary); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .kpi-value { font-size: 32px; font-weight: 700; letter-spacing: -1px; margin-bottom: 12px; }
        .kpi-card.revenue .kpi-value { color: var(--accent-green); }
        .kpi-card.expenses .kpi-value { color: var(--accent-red); }
        .kpi-card.profit .kpi-value { color: var(--accent-blue); }
        .kpi-card.margin .kpi-value { color: var(--accent-yellow); }
        .kpi-card.doo .kpi-value { color: var(--accent-purple); }
        .kpi-change { display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 500; }
        .kpi-change.positive { color: var(--accent-green); }
        .kpi-change.negative { color: var(--accent-red); }
        
        /* Profit Margin Gauge */
        .margin-gauge { margin-top: 12px; }
        .gauge-bar { height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden; position: relative; }
        .gauge-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
        .gauge-target { position: absolute; top: -4px; bottom: -4px; width: 2px; background: white; }
        .gauge-labels { display: flex; justify-content: space-between; margin-top: 4px; font-size: 11px; color: var(--text-muted); }
        
        /* Two column layout */
        .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 32px; }
        .chart-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .chart-title { font-size: 16px; font-weight: 600; }
        .chart-container { height: 300px; position: relative; }
        
        /* Enhanced Categories */
        .categories-section { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; }
        .category-item { display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 12px; transition: all 0.2s; cursor: pointer; }
        .category-item:hover { background: var(--bg-card-hover); transform: translateX(4px); }
        .category-item:last-child { margin-bottom: 0; }
        .category-left { display: flex; align-items: center; gap: 12px; flex: 1; }
        .category-dot { width: 12px; height: 12px; border-radius: 4px; }
        .category-info { flex: 1; }
        .category-name { font-size: 14px; font-weight: 500; margin-bottom: 2px; }
        .category-percent { font-size: 12px; color: var(--text-muted); }
        .category-right { text-align: right; }
        .category-amount { font-size: 14px; font-weight: 600; font-family: 'JetBrains Mono', monospace; margin-bottom: 2px; }
        .category-change { font-size: 12px; font-weight: 500; display: flex; align-items: center; gap: 4px; justify-content: flex-end; }
        .category-change.up { color: var(--accent-red); }
        .category-change.down { color: var(--accent-green); }
        .category-change.neutral { color: var(--text-muted); }
        
        /* Weekly Spending Pulse */
        .spending-pulse { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; margin-bottom: 32px; }
        .pulse-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .pulse-title { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .pulse-alert { padding: 6px 12px; background: rgba(239, 68, 68, 0.15); color: var(--accent-red); border-radius: 6px; font-size: 12px; font-weight: 500; }
        .pulse-alert.good { background: rgba(16, 185, 129, 0.15); color: var(--accent-green); }
        .pulse-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
        .pulse-stat { background: var(--bg-secondary); border-radius: 12px; padding: 16px; text-align: center; }
        .pulse-stat-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
        .pulse-stat-value { font-size: 20px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .pulse-stat-value.green { color: var(--accent-green); }
        .pulse-stat-value.red { color: var(--accent-red); }
        .pulse-stat-value.yellow { color: var(--accent-yellow); }
        .daily-bars { display: flex; gap: 8px; align-items: flex-end; height: 100px; }
        .daily-bar-container { flex: 1; display: flex; flex-direction: column; align-items: center; }
        .daily-bar { width: 100%; background: var(--accent-blue); border-radius: 4px 4px 0 0; transition: height 0.3s; min-height: 4px; }
        .daily-bar.over-budget { background: var(--accent-red); }
        .daily-bar.under-budget { background: var(--accent-green); }
        .daily-label { font-size: 11px; color: var(--text-muted); margin-top: 8px; }
        .daily-amount { font-size: 10px; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; }
        
        /* Recurring Expenses */
        .recurring-section { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; margin-bottom: 32px; }
        .recurring-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .recurring-title { font-size: 18px; font-weight: 600; }
        .recurring-total { font-size: 14px; color: var(--text-secondary); }
        .recurring-total span { color: var(--accent-red); font-weight: 600; font-family: 'JetBrains Mono', monospace; }
        .recurring-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .recurring-item { display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--bg-secondary); border-radius: 12px; transition: all 0.2s; }
        .recurring-item:hover { background: var(--bg-card-hover); }
        .recurring-left { display: flex; align-items: center; gap: 12px; }
        .recurring-icon { width: 40px; height: 40px; background: var(--bg-card); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .recurring-info h4 { font-size: 14px; font-weight: 500; margin-bottom: 2px; }
        .recurring-info p { font-size: 12px; color: var(--text-muted); }
        .recurring-right { text-align: right; }
        .recurring-amount { font-size: 16px; font-weight: 600; font-family: 'JetBrains Mono', monospace; color: var(--accent-red); margin-bottom: 4px; }
        .recurring-action { padding: 4px 10px; background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); border: none; border-radius: 4px; font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .recurring-action:hover { background: rgba(59, 130, 246, 0.25); }
        
        /* DOO Section */
        .doo-section { background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(124, 58, 237, 0.05) 100%); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 16px; padding: 24px; margin-bottom: 32px; }
        .doo-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .doo-title { font-size: 18px; font-weight: 600; color: var(--accent-purple); }
        .doo-config { display: flex; align-items: center; gap: 12px; }
        .doo-config label { font-size: 13px; color: var(--text-secondary); }
        .doo-config input { width: 80px; padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px; font-family: 'JetBrains Mono', monospace; }
        .doo-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .doo-stat { text-align: center; padding: 20px; background: var(--bg-card); border-radius: 12px; }
        .doo-stat-label { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .doo-stat-value { font-size: 24px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--accent-purple); }
        .doo-stat-sub { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        
        /* Transactions */
        .transactions-section { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; margin-bottom: 32px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section-title { font-size: 18px; font-weight: 600; }
        .filter-tabs { display: flex; gap: 8px; }
        .filter-tab { padding: 6px 14px; background: transparent; border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-secondary); font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .filter-tab:hover, .filter-tab.active { background: var(--bg-card-hover); color: var(--text-primary); }
        .transactions-table { width: 100%; border-collapse: collapse; }
        .transactions-table th { text-align: left; padding: 12px 16px; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border-color); }
        .transactions-table td { padding: 16px; font-size: 14px; border-bottom: 1px solid var(--border-color); }
        .transactions-table tr:last-child td { border-bottom: none; }
        .transactions-table tr:hover td { background: var(--bg-secondary); }
        .transaction-type { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 500; }
        .transaction-type.income { background: rgba(16, 185, 129, 0.15); color: var(--accent-green); }
        .transaction-type.expense { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
        .amount-cell { font-family: 'JetBrains Mono', monospace; font-weight: 600; }
        .amount-cell.positive { color: var(--accent-green); }
        .amount-cell.negative { color: var(--accent-red); }
        
        /* Setup Screen */
        .setup-container { max-width: 600px; margin: 100px auto; text-align: center; }
        .setup-icon { width: 80px; height: 80px; background: var(--gradient-blue); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; font-size: 36px; }
        .setup-title { font-size: 28px; font-weight: 700; margin-bottom: 12px; }
        .setup-desc { font-size: 16px; color: var(--text-secondary); margin-bottom: 32px; line-height: 1.6; }
        .setup-btn { display: inline-flex; align-items: center; gap: 10px; padding: 16px 32px; background: var(--gradient-green); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .setup-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4); }
        
        /* Loading */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 14, 23, 0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .spinner { width: 48px; height: 48px; border: 3px solid var(--border-color); border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 16px; color: var(--text-secondary); }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: var(--bg-card); border-radius: 16px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; }
        .modal-close:hover { color: var(--text-primary); }
        
        @media (max-width: 1200px) { 
            .kpi-grid { grid-template-columns: repeat(2, 1fr); } 
            .main-grid { grid-template-columns: 1fr; } 
            .recurring-list { grid-template-columns: 1fr; }
            .pulse-stats { grid-template-columns: repeat(2, 1fr); }
            .doo-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) { 
            .kpi-grid { grid-template-columns: 1fr; } 
            .doo-grid { grid-template-columns: 1fr; } 
            .header { flex-direction: column; gap: 16px; } 
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const CONFIG = {
            API_BASE_URL: 'https://asap-financial-dashboard-backend-production-b444.up.railway.app',
            QUICKBOOKS_CLIENT_ID: 'ABlvo2Ct9EVpIvCAlMxuzVQITLsKwGl6r25k4W01DUSw5iLVOM',
            REDIRECT_URI: 'https://asap-financial-dashboard-backend-production-b444.up.railway.app/api/quickbooks/callback',
            DOO_DEFAULT_PERCENTAGE: 10,
            TARGET_PROFIT_MARGIN: 75,
            DAILY_BUDGET: 1500
        };

        const formatCurrency = function(amount) { 
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount); 
        };
        const formatPercent = function(value) { 
            return (value >= 0 ? '+' : '') + value.toFixed(1) + '%'; 
        };

        // KPI Card Component
        const KPICard = function(props) {
            return (
                <div className={"kpi-card " + props.type}>
                    <div className="kpi-label">{props.label}</div>
                    <div className="kpi-value">{props.format === 'percent' ? props.value.toFixed(1) + '%' : formatCurrency(props.value)}</div>
                    {props.change !== undefined && (
                        <div className={"kpi-change " + (props.changeDirection === 'inverse' ? (props.change <= 0 ? 'positive' : 'negative') : (props.change >= 0 ? 'positive' : 'negative'))}>
                            <span>{props.change >= 0 ? '‚Üë' : '‚Üì'}</span>
                            <span>{formatPercent(props.change)} vs last month</span>
                        </div>
                    )}
                    {props.children}
                </div>
            );
        };

        // Profit Margin Gauge
        const ProfitMarginGauge = function(props) {
            var percentage = Math.min(100, Math.max(0, props.value));
            var color = percentage >= props.target ? 'var(--accent-green)' : percentage >= props.target - 10 ? 'var(--accent-yellow)' : 'var(--accent-red)';
            return (
                <div className="margin-gauge">
                    <div className="gauge-bar">
                        <div className="gauge-fill" style={{ width: percentage + '%', background: color }}></div>
                        <div className="gauge-target" style={{ left: props.target + '%' }} title={"Target: " + props.target + "%"}></div>
                    </div>
                    <div className="gauge-labels">
                        <span>0%</span>
                        <span>Target: {props.target}%</span>
                        <span>100%</span>
                    </div>
                </div>
            );
        };

        // Cash Flow Chart
        const CashFlowChart = function(props) {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            useEffect(function() {
                if (chartRef.current && props.data && props.data.length > 0) {
                    if (chartInstance.current) chartInstance.current.destroy();
                    var ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: props.data.map(function(d) { return d.month; }),
                            datasets: [
                                { label: 'Revenue', data: props.data.map(function(d) { return d.revenue; }), backgroundColor: 'rgba(16, 185, 129, 0.8)', borderRadius: 6 },
                                { label: 'Expenses', data: props.data.map(function(d) { return d.expenses; }), backgroundColor: 'rgba(239, 68, 68, 0.8)', borderRadius: 6 }
                            ]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { position: 'top', labels: { color: '#94a3b8', font: { family: 'DM Sans' } } } },
                            scales: { 
                                x: { grid: { display: false }, ticks: { color: '#64748b' } }, 
                                y: { grid: { color: '#2a3548' }, ticks: { color: '#64748b', callback: function(value) { return '$' + (value / 1000) + 'k'; } } } 
                            }
                        }
                    });
                }
                return function() { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [props.data]);
            return <canvas ref={chartRef}></canvas>;
        };

        // Enhanced Category List
        const CategoryList = function(props) {
            var totalExpenses = props.categories.reduce(function(sum, cat) { return sum + cat.amount; }, 0);
            return (
                <div className="categories-section">
                    <div className="chart-header">
                        <h3 className="chart-title">üìä Expense Categories</h3>
                        <span style={{ fontSize: '13px', color: 'var(--text-muted)' }}>Click to drill down</span>
                    </div>
                    {props.categories.map(function(cat, idx) {
                        var percent = totalExpenses > 0 ? (cat.amount / totalExpenses * 100).toFixed(1) : 0;
                        var change = cat.change || 0;
                        return (
                            <div key={idx} className="category-item" onClick={function() { props.onCategoryClick && props.onCategoryClick(cat); }}>
                                <div className="category-left">
                                    <div className="category-dot" style={{ backgroundColor: cat.color }}></div>
                                    <div className="category-info">
                                        <div className="category-name">{cat.name}</div>
                                        <div className="category-percent">{percent}% of total</div>
                                    </div>
                                </div>
                                <div className="category-right">
                                    <div className="category-amount">{formatCurrency(cat.amount)}</div>
                                    <div className={"category-change " + (change > 0 ? 'up' : change < 0 ? 'down' : 'neutral')}>
                                        {change !== 0 && <span>{change > 0 ? '‚Üë' : '‚Üì'}</span>}
                                        <span>{change !== 0 ? Math.abs(change).toFixed(1) + '% vs last mo' : 'No change'}</span>
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // Weekly Spending Pulse
        const SpendingPulse = function(props) {
            var dailyData = props.dailySpending || [];
            var thisWeekTotal = dailyData.reduce(function(sum, d) { return sum + d.amount; }, 0);
            var lastWeekTotal = props.lastWeekTotal || thisWeekTotal;
            var weekChange = lastWeekTotal > 0 ? ((thisWeekTotal - lastWeekTotal) / lastWeekTotal * 100) : 0;
            var dailyAvg = dailyData.length > 0 ? thisWeekTotal / dailyData.length : 0;
            var maxDaily = Math.max.apply(null, dailyData.map(function(d) { return d.amount; }).concat([1]));
            var isOverBudget = dailyAvg > CONFIG.DAILY_BUDGET;
            
            return (
                <div className="spending-pulse">
                    <div className="pulse-header">
                        <div className="pulse-title">
                            <span>‚ö° Weekly Spending Pulse</span>
                            {isOverBudget ? (
                                <span className="pulse-alert">‚ö†Ô∏è Over daily budget</span>
                            ) : (
                                <span className="pulse-alert good">‚úì On track</span>
                            )}
                        </div>
                    </div>
                    <div className="pulse-stats">
                        <div className="pulse-stat">
                            <div className="pulse-stat-label">This Week</div>
                            <div className={"pulse-stat-value " + (thisWeekTotal > lastWeekTotal ? 'red' : 'green')}>{formatCurrency(thisWeekTotal)}</div>
                        </div>
                        <div className="pulse-stat">
                            <div className="pulse-stat-label">Last Week</div>
                            <div className="pulse-stat-value">{formatCurrency(lastWeekTotal)}</div>
                        </div>
                        <div className="pulse-stat">
                            <div className="pulse-stat-label">Daily Average</div>
                            <div className={"pulse-stat-value " + (dailyAvg > CONFIG.DAILY_BUDGET ? 'red' : 'green')}>{formatCurrency(dailyAvg)}</div>
                        </div>
                        <div className="pulse-stat">
                            <div className="pulse-stat-label">Week vs Week</div>
                            <div className={"pulse-stat-value " + (weekChange > 0 ? 'red' : 'green')}>{weekChange >= 0 ? '+' : ''}{weekChange.toFixed(1)}%</div>
                        </div>
                    </div>
                    <div className="daily-bars">
                        {dailyData.map(function(d, idx) {
                            var height = maxDaily > 0 ? (d.amount / maxDaily * 80) : 4;
                            var isOver = d.amount > CONFIG.DAILY_BUDGET;
                            return (
                                <div key={idx} className="daily-bar-container">
                                    <div 
                                        className={"daily-bar " + (isOver ? 'over-budget' : 'under-budget')} 
                                        style={{ height: height + 'px' }}
                                        title={d.day + ': ' + formatCurrency(d.amount)}
                                    ></div>
                                    <div className="daily-label">{d.day}</div>
                                    <div className="daily-amount">{formatCurrency(d.amount)}</div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // Recurring Expenses
        const RecurringExpenses = function(props) {
            var items = props.items || [];
            var totalMonthly = items.reduce(function(sum, item) { return sum + item.amount; }, 0);
            return (
                <div className="recurring-section">
                    <div className="recurring-header">
                        <h2 className="recurring-title">üîÑ Top Recurring Expenses</h2>
                        <div className="recurring-total">Monthly Total: <span>{formatCurrency(totalMonthly)}</span></div>
                    </div>
                    <div className="recurring-list">
                        {items.slice(0, 10).map(function(item, idx) {
                            return (
                                <div key={idx} className="recurring-item">
                                    <div className="recurring-left">
                                        <div className="recurring-icon">{item.icon || 'üí≥'}</div>
                                        <div className="recurring-info">
                                            <h4>{item.name}</h4>
                                            <p>{item.frequency || 'Monthly'}</p>
                                        </div>
                                    </div>
                                    <div className="recurring-right">
                                        <div className="recurring-amount">{formatCurrency(item.amount)}/mo</div>
                                        <button className="recurring-action">Review</button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // DOO Section
        const DOOSection = function(props) {
            var monthlyProfit = props.monthlyData && props.monthlyData.length > 0 ? props.monthlyData[props.monthlyData.length - 1].profit : 0;
            var thisMonthShare = monthlyProfit * (props.percentage / 100);
            var ytdShare = props.profit * (props.percentage / 100);
            var monthlyAvg = props.monthlyData && props.monthlyData.length > 0 ? props.monthlyData.reduce(function(acc, m) { return acc + m.profit; }, 0) / props.monthlyData.length : 0;
            var projectedAnnual = monthlyAvg * 12 * (props.percentage / 100);
            
            // Calculate potential if expenses reduced by 10%
            var potentialProfit = props.revenue - (props.expenses * 0.9);
            var potentialShare = potentialProfit * (props.percentage / 100);
            var potentialGain = potentialShare - ytdShare;
            
            return (
                <div className="doo-section">
                    <div className="doo-header">
                        <h2 className="doo-title">üí∞ DOO Profit Share Calculator</h2>
                        <div className="doo-config">
                            <label>Profit Share %:</label>
                            <input type="number" value={props.percentage} onChange={function(e) { props.setPercentage(Number(e.target.value)); }} min="0" max="100" />
                        </div>
                    </div>
                    <div className="doo-grid">
                        <div className="doo-stat">
                            <div className="doo-stat-label">This Month's Share</div>
                            <div className="doo-stat-value">{formatCurrency(thisMonthShare)}</div>
                        </div>
                        <div className="doo-stat">
                            <div className="doo-stat-label">YTD Total Share</div>
                            <div className="doo-stat-value">{formatCurrency(ytdShare)}</div>
                        </div>
                        <div className="doo-stat">
                            <div className="doo-stat-label">Projected Annual</div>
                            <div className="doo-stat-value">{formatCurrency(projectedAnnual)}</div>
                        </div>
                        <div className="doo-stat" style={{ background: 'rgba(16, 185, 129, 0.1)', border: '1px solid rgba(16, 185, 129, 0.3)' }}>
                            <div className="doo-stat-label">üí° If Expenses ‚Üì10%</div>
                            <div className="doo-stat-value" style={{ color: 'var(--accent-green)' }}>+{formatCurrency(potentialGain)}</div>
                            <div className="doo-stat-sub">Extra annual earnings</div>
                        </div>
                    </div>
                </div>
            );
        };

        // Transactions Table
        const TransactionsTable = function(props) {
            return (
                <div className="transactions-section">
                    <div className="section-header">
                        <h2 className="section-title">üìã Recent Transactions</h2>
                        <div className="filter-tabs">
                            <button className={"filter-tab " + (props.filter === 'all' ? 'active' : '')} onClick={function() { props.setFilter('all'); }}>All</button>
                            <button className={"filter-tab " + (props.filter === 'income' ? 'active' : '')} onClick={function() { props.setFilter('income'); }}>Income</button>
                            <button className={"filter-tab " + (props.filter === 'expense' ? 'active' : '')} onClick={function() { props.setFilter('expense'); }}>Expenses</button>
                        </div>
                    </div>
                    <table className="transactions-table">
                        <thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Type</th><th style={{ textAlign: 'right' }}>Amount</th></tr></thead>
                        <tbody>
                            {props.transactions.filter(function(t) { return props.filter === 'all' || t.type === props.filter; }).slice(0, 10).map(function(t) {
                                return (
                                    <tr key={t.id}>
                                        <td>{t.date}</td>
                                        <td>{t.description}</td>
                                        <td>{t.category}</td>
                                        <td><span className={"transaction-type " + t.type}>{t.type === 'income' ? '‚Üë Income' : '‚Üì Expense'}</span></td>
                                        <td className={"amount-cell " + (t.amount >= 0 ? 'positive' : 'negative')} style={{ textAlign: 'right' }}>{t.amount >= 0 ? '+' : ''}{formatCurrency(Math.abs(t.amount))}</td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            );
        };

        // Setup Screen
        const SetupScreen = function(props) {
            return (
                <div className="setup-container">
                    <div className="setup-icon">üìä</div>
                    <h1 className="setup-title">Connect QuickBooks Online</h1>
                    <p className="setup-desc">Connect your QuickBooks Online account to start tracking your revenue, expenses, and profitability in real-time.</p>
                    <button className="setup-btn" onClick={function() { props.onConnect(false); }}><span>üîó</span>Connect to QuickBooks</button>
                    <p style={{ marginTop: '24px', color: 'var(--text-muted)', fontSize: '14px' }}>Or <button onClick={function() { props.onConnect(true); }} style={{ background: 'none', border: 'none', color: 'var(--accent-blue)', cursor: 'pointer', textDecoration: 'underline' }}>view demo dashboard</button></p>
                </div>
            );
        };

        // Main Dashboard
        const Dashboard = function(props) {
            const [transactionFilter, setTransactionFilter] = useState('all');
            const [refreshing, setRefreshing] = useState(false);
            const [lastSync, setLastSync] = useState(new Date());
            
            var data = props.data;
            var profitMargin = data.summary.totalRevenue > 0 ? (data.summary.netProfit / data.summary.totalRevenue * 100) : 0;
            
            // Generate weekly spending data from transactions
            var dailySpending = [];
            var days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            var today = new Date();
            for (var i = 6; i >= 0; i--) {
                var date = new Date(today);
                date.setDate(date.getDate() - i);
                var dayExpenses = (data.transactions || []).filter(function(t) {
                    return t.type === 'expense' && t.date === date.toISOString().split('T')[0];
                }).reduce(function(sum, t) { return sum + Math.abs(t.amount); }, 0);
                dailySpending.push({
                    day: days[date.getDay() === 0 ? 6 : date.getDay() - 1],
                    amount: dayExpenses || Math.random() * 2000 + 500 // Fallback to sample data
                });
            }
            
            // Generate recurring expenses from categories
            var recurringExpenses = (data.categories || []).map(function(cat, idx) {
                var icons = ['üíª', 'üë•', 'üì¢', 'üí≥', 'üì¶', 'üîß', 'üìä', '‚òÅÔ∏è'];
                return {
                    name: cat.name,
                    amount: cat.amount / 12, // Estimate monthly from YTD
                    icon: icons[idx] || 'üí≥',
                    frequency: 'Monthly'
                };
            }).sort(function(a, b) { return b.amount - a.amount; });
            
            var handleRefresh = function() {
                setRefreshing(true);
                fetch(CONFIG.API_BASE_URL + '/api/quickbooks/refresh')
                    .then(function(res) { return res.json(); })
                    .then(function(newData) {
                        if (newData && !newData.error) {
                            props.setData(newData);
                            setLastSync(new Date());
                        }
                        setRefreshing(false);
                    })
                    .catch(function(err) {
                        console.error('Refresh error:', err);
                        setRefreshing(false);
                    });
            };
            
            return (
                <div className="app-container">
                    <header className="header">
                        <div className="logo-section">
                            <div className="logo-icon">A$</div>
                            <div className="logo-text"><h1>ASAP Credit Repair</h1><span>Financial Dashboard</span></div>
                        </div>
                        <div className="header-actions">
                            <div className="sync-status"><div className="sync-dot"></div><span>Last sync: {lastSync.toLocaleTimeString()}</span></div>
                            <button className="refresh-btn" onClick={handleRefresh} disabled={refreshing}>
                                {refreshing ? '‚è≥ Refreshing...' : 'üîÑ Refresh Data'}
                            </button>
                        </div>
                    </header>
                    
                    {/* KPI Cards */}
                    <div className="kpi-grid">
                        <KPICard label="Total Revenue" value={data.summary.totalRevenue} change={data.summary.revenueChange} type="revenue" />
                        <KPICard label="Total Expenses" value={data.summary.totalExpenses} change={data.summary.expensesChange} changeDirection="inverse" type="expenses" />
                        <KPICard label="Net Profit" value={data.summary.netProfit} change={data.summary.profitChange} type="profit" />
                        <KPICard label="Profit Margin" value={profitMargin} format="percent" type="margin">
                            <ProfitMarginGauge value={profitMargin} target={CONFIG.TARGET_PROFIT_MARGIN} />
                        </KPICard>
                    </div>
                    
                    {/* Weekly Spending Pulse */}
                    <SpendingPulse 
                        dailySpending={dailySpending} 
                        lastWeekTotal={dailySpending.reduce(function(s,d){return s+d.amount;}, 0) * 0.9}
                    />
                    
                    {/* Charts and Categories */}
                    <div className="main-grid">
                        <div className="chart-card">
                            <div className="chart-header">
                                <h3 className="chart-title">üìà Cash Flow Overview</h3>
                            </div>
                            <div className="chart-container">
                                <CashFlowChart data={data.monthlyData} />
                            </div>
                        </div>
                        <CategoryList categories={data.categories || []} />
                    </div>
                    
                    {/* Recurring Expenses */}
                    <RecurringExpenses items={recurringExpenses} />
                    
                    {/* DOO Section */}
                    <DOOSection 
                        profit={data.summary.netProfit} 
                        revenue={data.summary.totalRevenue}
                        expenses={data.summary.totalExpenses}
                        monthlyData={data.monthlyData} 
                        percentage={props.dooPercentage} 
                        setPercentage={props.setDooPercentage} 
                    />
                    
                    {/* Transactions */}
                    <TransactionsTable 
                        transactions={data.transactions || []} 
                        filter={transactionFilter} 
                        setFilter={setTransactionFilter} 
                    />
                </div>
            );
        };

        // Main App
        const App = function() {
            const [isConnected, setIsConnected] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [data, setData] = useState(null);
            const [dooPercentage, setDooPercentage] = useState(CONFIG.DOO_DEFAULT_PERCENTAGE);

            var handleConnect = function(demo) {
                if (demo) { 
                    setData({
                        summary: { totalRevenue: 1220204, totalExpenses: 287270, netProfit: 932934, revenueChange: 8.5, expensesChange: -2.1, profitChange: 12.3 },
                        monthlyData: [
                            { month: 'Jul', revenue: 180000, expenses: 42000, profit: 138000 },
                            { month: 'Aug', revenue: 195000, expenses: 45000, profit: 150000 },
                            { month: 'Sep', revenue: 210000, expenses: 48000, profit: 162000 },
                            { month: 'Oct', revenue: 205000, expenses: 50000, profit: 155000 },
                            { month: 'Nov', revenue: 220000, expenses: 52000, profit: 168000 },
                            { month: 'Dec', revenue: 210000, expenses: 50000, profit: 160000 }
                        ],
                        categories: [
                            { name: 'Software', amount: 108467, color: '#ef4444', change: 12 },
                            { name: 'Payroll', amount: 107162, color: '#f59e0b', change: 0 },
                            { name: 'VA Services', amount: 51953, color: '#3b82f6', change: -5 },
                            { name: 'Supplies', amount: 10250, color: '#8b5cf6', change: 8 },
                            { name: 'Advertising', amount: 3771, color: '#64748b', change: -15 }
                        ],
                        transactions: []
                    });
                    setIsConnected(true); 
                    setIsLoading(false);
                    return; 
                }
                var authUrl = "https://appcenter.intuit.com/connect/oauth2?client_id=" + CONFIG.QUICKBOOKS_CLIENT_ID + "&response_type=code&scope=com.intuit.quickbooks.accounting&redirect_uri=" + encodeURIComponent(CONFIG.REDIRECT_URI) + "&state=security_token";
                window.location.href = authUrl;
            };

            useEffect(function() {
                fetch(CONFIG.API_BASE_URL + '/api/quickbooks/status')
                    .then(function(res) { return res.json(); })
                    .then(function(status) {
                        if (status.connected) {
                            setIsConnected(true);
                            return fetch(CONFIG.API_BASE_URL + '/api/quickbooks/data');
                        } else {
                            setIsLoading(false);
                            return null;
                        }
                    })
                    .then(function(res) { return res ? res.json() : null; })
                    .then(function(financialData) {
                        if (financialData && !financialData.error) {
                            setData(financialData);
                        }
                        setIsLoading(false);
                    })
                    .catch(function(err) {
                        console.log('Status check error:', err);
                        setIsLoading(false);
                    });

                var urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('connected') === 'true') {
                    setIsConnected(true);
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }, []);

            if (isLoading) return (<div className="loading-overlay"><div className="spinner"></div><div className="loading-text">Loading dashboard...</div></div>);
            if (!isConnected || !data) return <SetupScreen onConnect={handleConnect} />;
            return <Dashboard data={data} setData={setData} dooPercentage={dooPercentage} setDooPercentage={setDooPercentage} />;
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
